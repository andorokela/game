<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Обнаружение границ с помощью Canny</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
    }
    h1 {
      font-size: 24px;
      text-align: center;
    }
    canvas {
      border: 1px solid #000;
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    .controls {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .controls label {
      font-size: 16px;
    }
    .controls input[type="range"] {
      width: 100%;
    }
    .controls button {
      padding: 10px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .controls button:hover {
      background-color: #0056b3;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .slider-container span {
      font-size: 16px;
      min-width: 40px;
      text-align: right;
    }
    .file-input-container {
      display: flex;
      gap: 10px;
    }
    .file-input-container button {
      flex: 1;
    }
    video {
      display: none; /* Скрываем видеоэлемент */
    }
    #captureButton {
      display: none; /* Скрываем кнопку "Сделать снимок" по умолчанию */
    }
    #switchCameraButton {
      display: none; /* Скрываем кнопку "Сменить камеру" по умолчанию */
    }
    .loading-spinner {
      display: none;
      font-size: 16px;
      color: #007bff;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Обнаружение границ с помощью Canny</h1>
  <div class="controls">
    <div class="file-input-container">
      <button id="filePickerButton">Выбрать файл</button>
      <button id="cameraButton">Сделать фото</button>
      <button id="captureButton">Сделать снимок</button>
      <button id="switchCameraButton">Сменить камеру</button>
    </div>
    <!-- Поле для выбора файла -->
    <input type="file" id="imageInput" accept="image/*" style="display: none;" />
    <!-- Видеоэлемент для камеры -->
    <video id="video" autoplay></video>
    <div class="slider-container">
      <label for="threshold1">Порог 1:</label>
      <input type="range" id="threshold1" min="0" max="500" value="100" />
      <span id="threshold1Value">100</span>
    </div>
    <div class="slider-container">
      <label for="threshold2">Порог 2:</label>
      <input type="range" id="threshold2" min="0" max="500" value="200" />
      <span id="threshold2Value">200</span>
    </div>
    <button id="applyCannyButton">Применить Canny</button>
    <button id="saveSvgButton">Сохранить SVG</button>
    <div class="loading-spinner" id="loadingSpinner">Переключение камеры...</div>
  </div>
  <canvas id="canvas"></canvas>
  <!-- Локальная библиотека OpenCV.js -->
  <script src="https://andorokela.github.io/game/opencv.js" type="text/javascript"></script>
  <script>
    // Ждем загрузки OpenCV.js
    function onOpenCvReady() {
      console.log("OpenCV.js загружен и готов к использованию.");
      initApp(); // Инициализация приложения после загрузки OpenCV
    }

    // Инициализация приложения
    function initApp() {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const video = document.getElementById('video');
      const captureButton = document.getElementById('captureButton');
      const filePickerButton = document.getElementById('filePickerButton');
      const cameraButton = document.getElementById('cameraButton');
      const switchCameraButton = document.getElementById('switchCameraButton');
      const applyCannyButton = document.getElementById('applyCannyButton');
      const saveSvgButton = document.getElementById('saveSvgButton');
      const loadingSpinner = document.getElementById('loadingSpinner');

      let img;
      let isCameraActive = false;
      let currentFacingMode = 'environment'; // По умолчанию задняя камера
      let currentStream = null; // Текущий поток камеры

      // Элементы управления
      const threshold1Input = document.getElementById('threshold1');
      const threshold2Input = document.getElementById('threshold2');
      const threshold1Value = document.getElementById('threshold1Value');
      const threshold2Value = document.getElementById('threshold2Value');

      // Обновление числовых значений
      threshold1Input.addEventListener('input', () => {
        threshold1Value.textContent = threshold1Input.value;
        applyCanny(); // Применяем фильтр Canny при изменении ползунка
      });

      threshold2Input.addEventListener('input', () => {
        threshold2Value.textContent = threshold2Input.value;
        applyCanny(); // Применяем фильтр Canny при изменении ползунка
      });

      // Функция для открытия файлового picker
      function openFilePicker() {
        const input = document.getElementById('imageInput');
        input.click();
      }

      // Функция для открытия камеры
      async function openCamera(facingMode) {
        if (isCameraActive) {
          currentStream.getTracks().forEach(track => track.stop());
          isCameraActive = false;
        }
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode } });
          video.srcObject = stream; // Присваиваем новый поток элементу <video>
          video.play(); // Запускаем воспроизведение
          isCameraActive = true;
          currentStream = stream; // Сохраняем текущий поток
          currentFacingMode = facingMode; // Обновляем текущий режим камеры
          captureButton.style.display = 'block';
          switchCameraButton.style.display = 'block'; // Показываем кнопку смены камеры
          requestAnimationFrame(drawCameraFrame); // Запускаем отрисовку кадров
        } catch (error) {
          alert('Не удалось получить доступ к камере: ' + error.message);
        }
      }

      // Функция для отрисовки кадров с камеры на холсте
      function drawCameraFrame() {
        if (!isCameraActive) return;
        const maxWidth = window.innerWidth * 0.9;
        const aspectRatio = video.videoWidth / video.videoHeight;
        canvas.width = maxWidth;
        canvas.height = maxWidth / aspectRatio;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        requestAnimationFrame(drawCameraFrame);
      }

      // Функция для смены камеры
      async function switchCamera() {
        if (!isCameraActive) return;

        // Показываем индикатор загрузки
        switchCameraButton.disabled = true;
        loadingSpinner.style.display = 'block';

        // Определяем новую камеру
        const newFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';

        // Останавливаем текущий поток камеры
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }

        // Открываем новую камеру
        try {
          await openCamera(newFacingMode);
        } catch (error) {
          alert('Ошибка при переключении камеры: ' + error.message);
        } finally {
          // Скрываем индикатор загрузки
          switchCameraButton.disabled = false;
          loadingSpinner.style.display = 'none';
        }
      }

      // Назначаем обработчики событий
      filePickerButton.addEventListener('click', openFilePicker);
      cameraButton.addEventListener('click', () => openCamera(currentFacingMode));
      switchCameraButton.addEventListener('click', switchCamera);
      captureButton.addEventListener('click', capturePhoto);
      applyCannyButton.addEventListener('click', applyCanny);
      saveSvgButton.addEventListener('click', saveAsSvg);
    }

    // Проверка загрузки OpenCV
    cv['onRuntimeInitialized'] = onOpenCvReady;
  </script>
</body>
</html>
